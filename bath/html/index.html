<!DOCTYPE html>
<html>
  <head>
    <title>index</title>
    <meta http-equiv="X-UA-Compatible" content="IE=edge"/>
    <meta http-equiv="content-type" content="text/html; charset=utf-8"/>
    <link href="resources/css/axure_rp_page.css" type="text/css" rel="stylesheet"/>
    <link href="data/styles.css" type="text/css" rel="stylesheet"/>
    <link href="files/page_1/styles.css" type="text/css" rel="stylesheet"/>
    <script src="resources/scripts/jquery-3.2.1.min.js"></script>
  </head>
  <body>
      <!-- Unnamed (Rectangle) -->
      <div id="u0" class="ax_default box_1">
        <div id="u0_div">
          <div class="head ax_default">
            <div class="head_left" style="margin-top: 20px; padding-top: 15px; margin-left: 20px; width: 200px; text-align: left">
              <img src="images/page_1/regen/u4.svg"/>
              <span id="wait_num" style="margin-left: 4px;">0</span>
              <img src="images/page_1/regen/u6.svg" style="margin-left: 15px;"/>
              00:<span id="bath_pt_0">29</span>
            </div>
            <div class="head_right heading_1"  style="margin-top: 20px">
              <span>LEVEL</span>
              <span id="level">0</span>
              <img src="images/page_1/regen/u5.svg"/>
              <span id="earnings">0</span>
            </div>
          </div>

          <div id="left" class="ax_default">
            <!-- Unnamed (Rectangle) -->
            <div id="u1" >
              <div id="u1_div">
                <div id="rec_div"></div>
                <div id="chr_div"></div>
                <div id="bap_div"></div>
              </div>
            </div>
          </div>

          <div id="right">
        <!-- Unnamed (Rectangle) -->
        <div id="u2" class="ax_default box_1">
          <div id="u2_div">
            <div id="sau_div">
              <div class="c_fra_div">
                <img class="img_b" src="images/page_1/regen/u48.svg" onclick="$.buildNew('sau')"/>
              </div>
              <div class="c_fra_div">
                <img class="img_b" src="images/page_1/regen/u49.svg"/>
              </div>
            </div>
            <div id="spy_div">
              <div class="c_fra_div">
                <img class="img_b" src="images/page_1/regen/u48.svg" onclick="$.buildNew('spy')"/>
              </div>
              <div class="c_fra_div">
                <img class="img_b" src="images/page_1/regen/u49.svg" />
              </div>
            </div>
          </div>
        </div>
    </div>
        </div>
      </div>
    <script src="js/fun.js"></script>
      <script src="js/fun_fn.js"></script>
    <script>
      var userid = $.getQueryVariable("id");
      var costs = {"rec":1000, "chr":3000, "bap":5000, "sau":10000, "spy":10000};
      //1.worker
      var w = {"bath":{"p":{},"w":{}},"rec":{"p":{},"w":{}},"chr":{"p":{},"w":{}},"bap":{"p":{},"w":{}},"sau":{"p":{},"w":{}},"spy":{"p":{},"w":{}}};
      var baths = {
        "name": "bath",
        "name_zh": "酒店",
        "list":{
          0:{"p":{"num":0, "limit":0, "speed":30, "cost":0, "out":10}}
          // 0:{"p":{"num":0, "limit":0, "speed":5, "cost":0, "out":10}}
        },
        "next": null,
        "num": 1,
        'wait_num': 10,
      };

      var recs = {"name":"rec","name_zh":"前台","max":6,"num":0,"prior":null,"next":null,"list":{}};
      //当前人数, 最大人数, 更新速度, 每秒费用
      var rec_property = {
        "p":{"num":0, "limit":10, "speed":10, "cost":0, "out":1},
        "w":{"num":0, "limit":20, "speed":8,  "cost":0, "out":20}
      };

      var chrs = {"name":"chr","name_zh":"更衣室","max":6,"num":0,"prior":null,"next":null,"list":{}};
      var chr_property = {
        "p":{"num":0, "limit":10, "speed":10, "cost":10, "out":1},
        "w":{"num":0, "limit":10, "speed":12, "cost":0, "out":10}
      };

      var baps = {"name":"bap","name_zh":"浴池","max":6,"num":0,"prior":null,"next":null,"list":{}};
      var bap_property = {
        "p":{"num":0, "limit":10, "speed":15, "cost":20, "out":1},
        "w":{"num":0, "limit":10, "speed":20, "cost":0, "out":10}
      };

      var saus = {"name":"sau","name_zh":"桑拿","max":2,"num":0,"prior":null,"next":null,"list":{}};
      var sau_property = {
        "p":{"num":0, "limit":5, "speed":20, "cost":30, "out":1},
        "w":{"num":0, "limit":10, "speed":15, "cost":0, "out":10}
      };

      var spys = {"name":"spy","name_zh":"SPY","max":2,"num":0,"prior":null,"next":null,"list":{}};
      var spy_property = {
        "p":{"num":0, "limit":5, "speed":20, "cost":30, "out":1},
        "w":{"num":0, "limit":10, "speed":15, "cost":0, "out":10}
      };

      baths.next = recs;
      recs.next = chrs;
      chrs.next = baps; chrs.prior = recs;
      baps.next = saus; baps.prior = chrs;
      saus.next = spys; saus.prior = baps;
      spys.prior = saus;

      // startWorker: function (faes, number=0, sign="p")
      // eval('refresh('+r+','+number+','+sign+','+event.data+')');
      var refresh = function (name, number, sign, num) {
        var faes = eval(name+'s');
        var item = faes['list'][number][sign];
        if (num <= 0){
          $.cost(item['cost'] * item['speed']);
          $.stopWorker(name, number, sign);
          if (item['num']>0 || name=='bath'){
            $.nextFresh(faes, number, sign);
          }
          $.startWorker(faes, number, sign);
        }
        $('#'+name+'_'+sign+'t_'+number).html(num);
      }

      // var spyRefresh = function (name, refresh, num, number=0) {
      //   var r = spys[number];
      //   if (num <= 0){
      //     $.cost(r.spy_cost * r.duration);
      //     $.stopWorker(name, number);
      //     if (r.spy_p_num>0){
      //       $.nextFresh(r, number, name, {}, '', true);
      //     }
      //     $.startWorker(name, refresh, r.duration, number);
      //   }
      //   $('#spy_pt_'+number).html(num);
      //   $('#spy_wt_'+number).html(num);
      // }
      //
      // var sauRefresh = function (name, refresh, num, number=0) {
      //   var r = saus[number];
      //   if (num <= 0){
      //     $.cost(r.sau_cost * r.duration);
      //     $.stopWorker(name, number);
      //     if (r.sau_p_num>0){
      //       $.nextFresh(r, number, name, spys, 'spy');
      //     }
      //     $.startWorker(name, refresh, r.duration, number);
      //   }
      //   $('#sau_pt_'+number).html(num);
      //   $('#sau_wt_'+number).html(num);
      // }
      //
      // var bapRefresh = function (name, refresh, num, number=0) {
      //   var r = baps[number];
      //     if (num <= 0){
      //       $.cost(r.bap_cost * r.duration);
      //       $.stopWorker(name, number);
      //       if (r.bap_p_num>0){
      //         $.nextFresh(r, number, name, saus, 'sau');
      //       }
      //       $.startWorker(name, refresh, r.duration, number);
      //     }
      //     $('#bap_pt_'+number).html(num);
      //     $('#bap_wt_'+number).html(num);
      // }
      //
      // var chrRefresh = function (name, refresh, num, number=0) {
      //   var r = chrs[number];
      //     if (num <= 0){
      //       $.cost(r.chr_cost * r.duration);
      //       $.stopWorker(name, number);
      //       if (r.chr_p_num>0){
      //         $.nextFresh(r, number, name, baps, 'bap');
      //       }
      //       $.startWorker(name, refresh, r.duration, number);
      //     }
      //     $('#chr_pt_'+number).html(num);
      //     $('#chr_wt_'+number).html(num);
      // }
      //
      // var recRefresh = function (name, refresh, num, number=0) {
      //   var r = recs[number];
      //     if (num <= 0){
      //       $.stopWorker(name, number);
      //         var addNum = 0;
      //         if (r.rec_p_num>0){
      //           $.nextFresh(r, number, name, chrs, 'chr');
      //         }else if (r.rec_p_num==0){
      //           addNum = wait_num>r.rec_limit?r.rec_limit:wait_num;
      //           wait_num -= addNum;
      //           r.rec_p_num += addNum;
      //           $('#wait_num').html($.numFormat(wait_num));
      //
      //           $.allot(r, number, 'rec');
      //         }
      //
      //       $.startWorker(name, refresh, r.duration, number);
      //     }
      //     $('#rec_pt_'+number).html(num);
      //     $('#rec_wt_'+number).html(num);
      // }
      //
      // var bathRefresh = function(name, refresh, num){
      //     if (num==0){
      //         $.stopWorker(name);
      //         wait_num += 10;
      //         wait_num = wait_num>wait_limit?wait_limit:wait_num;
      //         $('#wait_num').html(wait_num);
      //       $.startWorker(name, refresh, duration);
      //     }
      //     document.getElementById("tmp").innerHTML = num;
      // }

      //2.websocket
      var ws;

      // js二进制操作可参考 https://my.oschina.net/appnet/blog/1647923
      window.onload = function () {
        console.log("hello")
        ws = new WebSocket("ws://127.0.0.1:18802/echo");
        ws.binaryType = "arraybuffer";

        ws.onopen = function() {
            $.sendData({Userid: userid, Location: "userinfo", Value: "00"});
        };

        ws.onmessage = function(evt) {
          if (evt.data instanceof ArrayBuffer ){
            let dv = new DataView(evt.data);

            // TODO 消息号验证
            let msgid = dv.getUint16(0, true)

            // 包体
            let msgBody = evt.data.slice(2)
            let decoder = new TextDecoder('utf8')
            let jsonBody = decoder.decode(msgBody)

            // 解码包体
            let msg = JSON.parse(jsonBody)
            manageData(msg)
            console.log( "Received Message: " , msg);
          }else{
            console.log("Require array buffer format")
          }
        };

        ws.onclose = function(evt) {
          console.log("Connection closed.");
        };
      }

      var manageData = function(msg){
        var data=JSON.parse(msg.Value)
        switch (msg.Location) {
          case "userinfo":
            $('#wait_num').html(baths.wait_num);
            $('#level').html(data.level)
            earnings = $.numFormat(data.earnings);
            $('#earnings').html($.format(data.earnings));
            $.buildInit(data);
            $.freshList(recs, chrs, baps, saus, spys);
            $.listWorker();
            break;
          default:
        }
      }

    </script>
  </body>
</html>