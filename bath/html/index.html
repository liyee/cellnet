<!DOCTYPE html>
<html>
  <head>
    <title>index</title>
    <meta http-equiv="X-UA-Compatible" content="IE=edge"/>
    <meta http-equiv="content-type" content="text/html; charset=utf-8"/>
    <link href="resources/css/axure_rp_page.css" type="text/css" rel="stylesheet"/>
    <link href="data/styles.css" type="text/css" rel="stylesheet"/>
    <link href="files/page_1/styles.css" type="text/css" rel="stylesheet"/>
    <script src="resources/scripts/jquery-3.2.1.min.js"></script>
  </head>
  <body>
      <!-- Unnamed (Rectangle) -->
      <div id="u0" class="ax_default box_1">
        <div id="u0_div">
          <div class="head ax_default">
            <div class="head_left" style="margin-top: 20px; padding-top: 15px; margin-left: 20px; width: 200px; text-align: left">
              <img src="images/page_1/regen/u4.svg"/>
              <span id="wait_num" style="margin-left: 4px;">0</span>
              <img src="images/page_1/regen/u6.svg" style="margin-left: 15px;"/>
              00:<span id="tmp">10</span>
            </div>
            <div class="head_right heading_1"  style="margin-top: 20px">
              <span>LEVEL</span>
              <span id="level">0</span>
              <img src="images/page_1/regen/u5.svg"/>
              <span id="earnings">0</span>
            </div>
          </div>

          <div id="left" class="ax_default">
            <!-- Unnamed (Rectangle) -->
            <div id="u1" >
              <div id="u1_div">
                <div id="rec_div"></div>
                <div id="chr_div"></div>
                <div id="bap_div"></div>
              </div>
            </div>
          </div>

          <div id="right">
        <!-- Unnamed (Rectangle) -->
        <div id="u2" class="ax_default box_1">
          <div id="u2_div">
            <div id="sau_div">
              <div class="c_fra_div">
                <img class="img_b" src="images/page_1/regen/u48.svg"/>
              </div>
              <div class="c_fra_div">
                <img class="img_b" src="images/page_1/regen/u48.svg"/>
              </div>
            </div>
            <div id="spy_div">
              <div class="c_fra_div">
                <img class="img_b" src="images/page_1/regen/u48.svg"/>
              </div>
              <div class="c_fra_div">
                <img class="img_b" src="images/page_1/regen/u48.svg"/>
              </div>
            </div>
          </div>
        </div>
    </div>
        </div>
      </div>
    <script src="js/fun.js"></script>
      <script src="js/fun_fn.js"></script>
    <script>
      var userid = $.getQueryVariable("id");
      //1.worker
      var w = {"bath":{},"rec":{},"chr":{},"bap":{},"sau":{},"spy":{}};
      var wait_limit = 15;
      var wait_num = 0;
      var earnings = 0;
      var duration = 10;//来客间隔时长

      var recs = new Object();
      //可容纳人数, 前台服务人数, 前台最大服务人数, 前台等待人数, 每人服务时长
      var rec_property = {"rec_limit":25, "rec_p_num":0, "rec_p_limit":20, "rec_w_num":0, "duration":10, "rec_cost":0};
      recs[0] = Object.assign({}, rec_property);

      var chrs = new Object();
      //可容纳人数, 更衣室服务人数, 更衣室最大服务人数, 更衣室等待人数, 每人服务时长, 每秒费用
      var chr_property = {"chr_limit":15, "chr_p_num":0,"chr_p_limit":10,"chr_w_num":0, "duration":10, "chr_cost":10};
      chrs[0] = Object.assign({}, chr_property);

      var baps = new Object();
      //可容纳人数, 浴池服务人数, 浴池最大服务人数, 浴池等待人数, 每人服务时长, 每秒费用
      var bap_property = {"bap_limit":15, "bap_p_num":0,"bap_p_limit":10,"bap_w_num":0, "duration":10, "bap_cost":10};
      baps[0] = Object.assign({}, bap_property);

      var saus = new Object();
      //可容纳人数, 服务人数, 最大服务人数, 等待人数, 每人服务时长, 每秒费用   [桑拿]
      var sau_property = {"sau_limit":15, "sau_p_num":0,"sau_p_limit":10,"sau_w_num":0, "duration":10, "sau_cost":10};
      saus[0] = Object.assign({}, sau_property);

      var spys = new Object();
      //可容纳人数, 服务人数, 最大服务人数, 等待人数, 每人服务时长, 每秒费用   [SPY]
      var spy_property = {"spy_limit":15, "spy_p_num":0,"spy_p_limit":10,"spy_w_num":0, "duration":10, "spy_cost":10};
      spys[0] = Object.assign({}, spy_property);

      var rec_add = function () {
        recs[Object.keys(recs).length] = Object.assign({}, rec_property);
        $.freshList(recs, chrs, baps, saus, spys);
        $.startWorker("rec",  "recRefresh", rec_property.duration, Object.keys(recs).length-1);//前台
      }

      var chr_add = function () {
        chrs[Object.keys(chrs).length] = chr_property;
        $.freshList(recs, chrs, baps, saus, spys);
        $.startWorker("chr",  "chrRefresh", chr_property.duration, Object.keys(chrs).length-1);//更衣室
      }

      var bap_add = function () {
        baps[Object.keys(baps).length] = bap_property;
        $.freshList(recs, chrs, baps, saus, spys);
        $.startWorker("bap",  "bapRefresh", bap_property.duration, Object.keys(baps).length -1);//浴池
      }

      var sau_add = function () {
        saus[Object.keys(saus).length] = sau_property;
        $.freshList(recs, chrs, baps, saus, spys);
        $.startWorker("sau",  "sauRefresh", sau_property.duration, Object.keys(saus).length -1);//桑拿
      }

      var spy_add = function () {
        spys[Object.keys(spys).length] = spy_property;
        $.freshList(recs, chrs, spys, saus, spys);
        $.startWorker("spy",  "spyRefresh", spy_property.duration, Object.keys(spys).length -1);//SPY
      }

      var spyRefresh = function (name, refresh, num, number=0) {
        var r = spys[number];
        if (num <= 0){
          $.cost(r.spy_cost * r.duration);
          $.stopWorker(name, number);
          if (r.spy_p_num>0){
            $.nextFresh(r, number, name, {}, '', true);
          }
          $.startWorker(name, refresh, r.duration, number);
        }
        $('#spy_pt_'+number).html(num);
        $('#spy_wt_'+number).html(num);
      }

      var sauRefresh = function (name, refresh, num, number=0) {
        var r = saus[number];
        if (num <= 0){
          $.cost(r.sau_cost * r.duration);
          $.stopWorker(name, number);
          if (r.sau_p_num>0){
            $.nextFresh(r, number, name, spys, 'spy');
          }
          $.startWorker(name, refresh, r.duration, number);
        }
        $('#sau_pt_'+number).html(num);
        $('#sau_wt_'+number).html(num);
      }

      var bapRefresh = function (name, refresh, num, number=0) {
        var r = baps[number];
          if (num <= 0){
            $.cost(r.bap_cost * r.duration);
            $.stopWorker(name, number);
            if (r.bap_p_num>0){
              $.nextFresh(r, number, name, saus, 'sau');
            }
            $.startWorker(name, refresh, r.duration, number);
          }
          $('#bap_pt_'+number).html(num);
          $('#bap_wt_'+number).html(num);
      }

      var chrRefresh = function (name, refresh, num, number=0) {
        var r = chrs[number];
          if (num <= 0){
            $.cost(r.chr_cost * r.duration);
            $.stopWorker(name, number);
            if (r.chr_p_num>0){
              $.nextFresh(r, number, name, baps, 'bap');
            }
            $.startWorker(name, refresh, r.duration, number);
          }
          $('#chr_pt_'+number).html(num);
          $('#chr_wt_'+number).html(num);
      }

      var recRefresh = function (name, refresh, num, number=0) {
        var r = recs[number];
          if (num <= 0){
            $.stopWorker(name, number);
              var addNum = 0;
              if (r.rec_p_num>0){
                $.nextFresh(r, number, name, chrs, 'chr');
              }else if (r.rec_p_num==0){
                addNum = wait_num>r.rec_limit?r.rec_limit:wait_num;
                wait_num -= addNum;
                r.rec_p_num += addNum;
                $('#wait_num').html($.numFormat(wait_num));

                $.allot(r, number, 'rec');
              }

            $.startWorker(name, refresh, r.duration, number);
          }
          $('#rec_pt_'+number).html(num);
          $('#rec_wt_'+number).html(num);
      }

      var bathRefresh = function(name, refresh, num){
          if (num==0){
              $.stopWorker(name);
              wait_num += 10;
              wait_num = wait_num>wait_limit?wait_limit:wait_num;
              $('#wait_num').html(wait_num);
            $.startWorker(name, refresh, duration);
          }
          document.getElementById("tmp").innerHTML = num;
      }

      //2.websocket
      var ws;

      // js二进制操作可参考 https://my.oschina.net/appnet/blog/1647923
      window.onload = function () {
        console.log("hello")
        ws = new WebSocket("ws://127.0.0.1:18802/echo");
        ws.binaryType = "arraybuffer";

        ws.onopen = function(evt) {
          $.sendDate({
            Userid: userid,
            Location: "info",
            Value: "01",
          });
        };

        ws.onmessage = function(evt) {
          if (evt.data instanceof ArrayBuffer ){
            let dv = new DataView(evt.data);

            // TODO 消息号验证
            let msgid = dv.getUint16(0, true)

            // 包体
            let msgBody = evt.data.slice(2)
            let decoder = new TextDecoder('utf8')
            let jsonBody = decoder.decode(msgBody)

            // 解码包体
            let msg = JSON.parse(jsonBody)
            manageData(msg)
            console.log( "Received Message: " , msg);
          }else{
            console.log("Require array buffer format")
          }
        };

      ws.onclose = function(evt) {
          console.log("Connection closed.");
        };
      }

      var manageData = function(msg){
        var data=JSON.parse(msg.Value)
        switch (msg.Location) {
          case "userinfo":
            $('#level').html(data.level)
            earnings = $.numFormat(data.earnings);
            $('#earnings').html($.format(data.earnings));
            $.freshList(recs, chrs, baps, saus, spys);
            $.listWorker();
            break;
          default:
        }
      }
    </script>
  </body>
</html>